<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPPT Dashboard</title>
    <!-- Thứ tự load script phải đúng -->
    <script src="/static/js/chart.umd.min.js"></script>
<script src="/static/js/luxon.min.js"></script>
<script src="/static/js/chartjs-adapter-luxon.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #1e1e1e; color: #d4d4d4; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-start; gap: 20px; padding: 20px; }
        .card { width: 100%; max-width: 450px; min-width: 350px; padding: 25px; background-color: #2d2d2d; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .chart-container { width: 100%; max-width: 800px; padding: 25px; background-color: #2d2d2d; border-radius: 10px; }
        h2 { text-align: center; color: #4e9a06; margin-top: 0; }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #444; font-size: 1.1em; }
        .metric:last-child { border-bottom: none; }
        .label { color: #a0a0a0; }
        .value { font-weight: 600; color: #73d216; }
        .logout { position: absolute; top: 20px; right: 20px; color: #a0a0a0; text-decoration: none; }
    </style>
</head>
<body>
    <a href="{{ url_for('logout') }}" class="logout">Logout</a>
    <div class="container">
        <div class="card">
            <h2>Live Data</h2>
            <div class="metric"><span class="label">Voltage:</span><span id="voltage-value" class="value">-- V</span></div>
            <div class="metric"><span class="label">Temperature:</span><span id="temp-value" class="value">-- °C</span></div>
            <div class="metric"><span class="label">Battery Current:</span><span id="battery-curr-value" class="value">-- A</span></div>
            <div class="metric"><span class="label">Last Updated:</span><span id="timestamp-value" class="value">--</span></div>
        </div>
        <div class="chart-container">
            <h2>History (Last 10 Minutes)</h2>
            <canvas id="historyChart"></canvas>
        </div>
    </div>

    <script>
        // === PHẦN LIVE DATA ===
        async function updateLiveData() {
            try {
                const response = await fetch("/api/latest-data");
                const data = await response.json();
                document.getElementById('voltage-value').textContent = data.voltage !== undefined ? data.voltage.toFixed(1) + ' V' : '-- V';
                document.getElementById('temp-value').textContent = data.temp !== undefined ? data.temp.toFixed(1) + ' °C' : '-- °C';
                document.getElementById('battery-curr-value').textContent = data.battery_curr !== undefined ? data.battery_curr.toFixed(1) + ' A' : '-- A';
                if (data.timestamp) {
                    document.getElementById('timestamp-value').textContent = new Date(data.timestamp).toLocaleTimeString('en-GB');
                }
            } catch (error) { console.error('Lỗi Live Data:', error); }
        }
        setInterval(updateLiveData, 2000);
        updateLiveData();

        // === PHẦN BIỂU ĐỒ (PHIÊN BẢN ĐÚNG) ===
        const ctx = document.getElementById('historyChart').getContext('2d');
        const historyChart = new Chart(ctx, {
            type: 'line',
            data: {
                // labels sẽ được điền tự động bởi adapter thời gian
                datasets: [
                    { label: 'Voltage (V)', data: [], borderColor: '#73d216', yAxisID: 'y' },
                    { label: 'Temperature (°C)', data: [], borderColor: '#3465a4', yAxisID: 'y1' }
                ]
            },
            options: {
                scales: {
                    x: { type: 'time', time: { unit: 'minute' }, ticks: { color: '#a0a0a0' } },
                    y: { type: 'linear', position: 'left', ticks: { color: '#73d216' } },
                    y1: { type: 'linear', position: 'right', ticks: { color: '#3465a4' }, grid: { drawOnChartArea: false } }
                },
                plugins: { legend: { labels: { color: '#d4d4d4' } } }
            }
        });

        async function updateChart() {
            try {
                const response = await fetch("/api/historical-data");
                const history = await response.json();
                
                // Chuyển đổi dữ liệu sang định dạng mà Chart.js hiểu
                const voltageData = history.map(d => ({ x: d.time, y: d.voltage }));
                const tempData = history.map(d => ({ x: d.time, y: d.temperature }));
                
                // Cập nhật dữ liệu cho biểu đồ
                historyChart.data.datasets[0].data = voltageData;
                historyChart.data.datasets[1].data = tempData;
                historyChart.update(); // Vẽ lại biểu đồ
            } catch (error) { console.error('Lỗi cập nhật biểu đồ:', error); }
        }
        setInterval(updateChart, 10000);
        updateChart();
    </script>
</body>
</html>